# Copyright (c) 2016 Surya Suluh and osrmnet contributors.  All rights reserved.
# Licensed under the MIT License.  See included LICENSE in the project root for license information.

# Master Branch (Release is controlled by Tag)
-
  shallow_clone: true
  clone_depth: 1
  version: 0.1.0.{build}
  pull_requests:
    do_not_increment_build_number: true
  branches:
    only:
      - master
  configuration: Release
  platform: x64
  image: Visual Studio 2015
  # Uncomment to debug the AV build worker
  # init:
  # - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
  clone_script:
  - ps: >-  
      if(-not $env:appveyor_pull_request_number) {
        git clone --depth=1 -q -c filter.lfs.smudge= -c filter.lfs.required=false --branch=$env:appveyor_repo_branch https://github.com/$env:appveyor_repo_name.git $env:appveyor_build_folder
        git checkout -qf $env:appveyor_repo_commit
        git lfs pull
      }
      else {
        git clone -q -c filter.lfs.smudge= -c filter.lfs.required=false https://github.com/$env:appveyor_repo_name.git $env:appveyor_build_folder
        git fetch -q origin +refs/pull/$env:appveyor_pull_request_number/merge:
        git checkout -qf FETCH_HEAD
        git lfs pull
      }
  cache:
  - .\src\packages -> .\src\**\packages.config
  - .\src\osrm.net\libosrm -> .\libosrmver.txt
  - .\src\Test\osrm.net.test\TestData -> .\libosrmver.txt
  before_build:
  - appveyor-retry nuget restore .\src\osrm.net.sln
  - ps: .\build.ps1

  build_script:
  - msbuild .\src\osrm.net.sln /t:Rebuild /p:Configuration=Release;Platform="x64" /m
  - nuget.exe pack .\src\osrm.net\osrm.net.nuspec -NonInteractive  -Version %APPVEYOR_BUILD_VERSION%-pre
  artifacts:
  - path: '*.nupkg'
  assembly_info:
    patch: true
    file: AssemblyInfo.*
    assembly_version: "0.1.0.{build}"
    assembly_file_version: "0.1.0.{build}"
    assembly_informational_version: "0.1.0.{build}-pre"
  test:
    assemblies: '**\*.Test.dll'
  deploy:
    provider: NuGet
    api_key:
      secure: EOx473RuAtGsqMKKDlZoUOx/2ae4fH0nYt2yVpP2y7sUJ02fZ6pGEHH+zthADQYG
    skip_symbols: false
    on:
      branch: master
      appveyor_repo_tag: true
  # Uncomment to debug the AV build worker
  # on_finish:
  # - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))